<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">GDScript RefCounted | ThiagoLA92</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://thiagola92.github.io/img/social_card.svg"><meta data-rh="true" name="twitter:image" content="https://thiagola92.github.io/img/social_card.svg"><meta data-rh="true" property="og:url" content="https://thiagola92.github.io/blog/godot-refcounted"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="GDScript RefCounted | ThiagoLA92"><meta data-rh="true" name="description" content="Eu passei um dia inteiro curioso para saber o como funcionava contagem por referência no GDScript (não o conceito mas sim os detalhes tecnicos). Triste por ver que a documentação não conseguiu tirar as dúvidas que eu tinha e até pensei que só saberia mais testando ou olhando o código em C++."><meta data-rh="true" property="og:description" content="Eu passei um dia inteiro curioso para saber o como funcionava contagem por referência no GDScript (não o conceito mas sim os detalhes tecnicos). Triste por ver que a documentação não conseguiu tirar as dúvidas que eu tinha e até pensei que só saberia mais testando ou olhando o código em C++."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-02-18T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/thiagola92"><meta data-rh="true" property="article:tag" content="godot,gdscript,refcounted"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://thiagola92.github.io/blog/godot-refcounted"><link data-rh="true" rel="alternate" href="https://thiagola92.github.io/blog/godot-refcounted" hreflang="en"><link data-rh="true" rel="alternate" href="https://thiagola92.github.io/pt-br/blog/godot-refcounted" hreflang="pt-br"><link data-rh="true" rel="alternate" href="https://thiagola92.github.io/blog/godot-refcounted" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ThiagoLA92 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ThiagoLA92 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.37910aa6.css">
<link rel="preload" href="/assets/js/runtime~main.d3819409.js" as="script">
<link rel="preload" href="/assets/js/main.ada9be12.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Website Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Website Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ThiagoLA92</b></a><a class="navbar__item navbar__link" href="/docs/about">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tubmlr">Tumblr</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sieve">Sieve</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/svg-inkscape">SVG Inkscape</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/godot-refcounted">GDScript RefCounted</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godot-array">GDScript Array</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">GDScript RefCounted</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-02-18T00:00:00.000Z" itemprop="datePublished">February 18, 2023</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/thiagola92" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://cdn.discordapp.com/attachments/807746464833863709/1110163174289850378/tiktok.png" alt="Thiago Lages de Alencar"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/thiagola92" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Thiago Lages de Alencar</span></a></div><small class="avatar__subtitle" itemprop="description">Desenvolvedor de Software</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Eu passei um dia inteiro curioso para saber o como funcionava contagem por referência no GDScript (não o conceito mas sim os detalhes tecnicos). Triste por ver que a documentação não conseguiu tirar as dúvidas que eu tinha e até pensei que só saberia mais testando ou olhando o código em C++.</p><p>Até que por acaso esbarrei em um comentário de um video que simplesmente explica <strong>muito</strong> bem.</p><blockquote><p>I&#x27;ve been following along in the course, but this particular video contains a lot of misinformation about Godot&#x27;s internals. I&#x27;ll clarify below:</p><p>All variables defined in Godot&#x27;s scripting API are wrapped in an object called a Variant. Each Variant is capable of storing different data types (int, string, bool, Object, Array, Dictionary, Color, Transform, etc.). You can see a list of the supported types <code>TYPE_*</code> enum values in the @GlobalScope class API documentation. This Variant class is why GDScript is able to change variable data types dynamically. Internally, every variable is a Variant. When you specify that a variable is typed and can only contain a single type, it is the GDScript language implementation, not Godot Engine, that blocks the type change.</p><p>Now, if a Variant B is assigned to another Variant A, then MOST of the time, the B&#x27;s value is &quot;copied by value&quot;, meaning that the direct value is copied from B to A. There is no reference counting of any kind. They are primitive values. In fact, reference counting primitive values is generally a waste of time and less performant than just copying them directly. This is because, for reference counting, you have to pass around a memory address in order to refer to the variable (because there is only one instance of the variable), and then getting the variable involves looking up the memory address. But for primitive numeric values such as int, float, or bool, passing the direct value takes just as much memory (less than 64 bits or 8 bytes) as passing a memory address. And if you pass a direct value, then the other Variant doesn&#x27;t have to look up the value in the first place; they already have it.</p><p>There are only three data types in Godot 3.2.x and prior that &quot;copy by reference&quot;, i.e. pass a memory address when assigning to a new variable: Object, Array, and Dictionary. EVERYTHING else will copy by value. In Godot 4.0 and beyond, the various Pool*Array classes, such as PoolIntArray, PoolStringArray, etc., will also be updated to copy by reference. With &quot;copy by reference&quot; data types, if you create one of those values and assign it to two variables, then modifying either one of the variables&#x27; values will modify both variables&#x27; values, since they both refer to the same memory address.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var x = [1, 2, 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var y = x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x.push_back(4) # y is now also [1,2,3,4]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As for reference counting, that is ONLY supported in Object classes that extend the Reference class. The top of the class hierarchy looks a bit like this...</p><ul><li>Object  <ul><li>Node  <ul><li>CanvasItem  <ul><li>Node2D  </li><li>Control  </li></ul></li><li>Spatial  </li></ul></li><li>Reference  <ul><li>Resource  </li></ul></li></ul></li></ul><p>So, Object has only direct new/free methods for allocating and deleting memory. Node and its subtypes can allocate memory, but 1) they can <code>.free()</code> immediately just like Objects or <code>.queue_free()</code> to schedule their deletion till the next frame (where you can more safely delete a large group of nodes at once), and 2) if you delete a Node, it also deletes all of that Node&#x27;s children, so an entire tree of nodes can be deleted just by deleting the root node of that tree. With Reference, you never delete it directly. It just auto-deletes when you stop having any references to it due to the fact that it actually DOES do reference-counting.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var ref = Reference.new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ref = null # the Reference object has now been freed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Resources behave just like References, except in their case, they can track their reference by their filepath as well. That is, if you do <code>load(&quot;res://my_file.gd&quot;)</code>, then you may end up loading a cached instance rather than allocating an entirely new object. If the engine&#x27;s internal ResourceCache finds that the resource has already been loaded, then the <code>load()</code> function will just return the memory address of the existing object rather than creating a new one.</p><p>Also note that the practice of creating an object pool for nodes and the like can be useful, but for different reasons than in other engines. This topic is quite advanced for people who may be learning programming for the first time, but: in stuff like C# (Unity), memory is &quot;garbage collected&quot;, i.e. the program tracks memory for you and auto-deletes it on your behalf. This can lead to random pauses in a game if the garbage collector suddenly starts up and interrupts gameplay to clean up memory. Object pooling, i.e. creating a group of objects and then just cycling through them rather than deleting and creating constantly, was a strategy to re-use existing memory for objects so as to stop the garbage collector from needing to run in the first place. But Godot does memory allocation manually and in small increments. It is designed in such a way that constantly creating and deleting objects doesn&#x27;t lead to long-term memory fragmentation, i.e. it doesn&#x27;t mess up your computer. You can read about this in the &quot;development&quot; section of the official documentation. Anyway, object pooling IS useful if, for performance reasons, you don&#x27;t want to waste TIME deleting and creating large objects, but you won&#x27;t need to worry about stuttering or memory issues, so most of the time, it&#x27;s perfectly fine in Godot to just create and delete objects as you need them.</p></blockquote><p>*Algumas adaptações foram feitas para melhorar aleitura (adicionar nova linha, transformar em bullet points, etc) mas nenhuma alteração em palavras ou frases foram feitas.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">​</a></h2><p>Video com este comentário: <a href="https://www.youtube.com/watch?v=9LaB6wbZepg" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=9LaB6wbZepg</a>  </p><p>Canal de quem comentou: <a href="https://www.youtube.com/channel/UC7uU5XaPB9uYKlowYOhEHnA" target="_blank" rel="noopener noreferrer">https://www.youtube.com/channel/UC7uU5XaPB9uYKlowYOhEHnA</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/godot">godot</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/gdscript">gdscript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/refcounted">refcounted</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/svg-inkscape"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">SVG Inkscape</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/godot-array"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">GDScript Array</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Thiago Lages de Alencar</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d3819409.js"></script>
<script src="/assets/js/main.ada9be12.js"></script>
</body>
</html>