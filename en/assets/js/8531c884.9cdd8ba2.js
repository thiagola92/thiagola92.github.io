"use strict";(self.webpackChunkthiagola_92_github_io=self.webpackChunkthiagola_92_github_io||[]).push([[2251],{31576:(e,o,s)=>{s.r(o),s.d(o,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var i=s(85893),n=s(11151);const r={authors:"thiagola92",tags:["file","files","database","multiple","lock"]},a="Write Safely to Files",l={permalink:"/en/blog/2025/10/04/write-safely-files",editUrl:"https://github.com/thiagola92/thiagola92.github.io/tree/master/blog/2025-10-04-write-safely-files/index.md",source:"@site/blog/2025-10-04-write-safely-files/index.md",title:"Write Safely to Files",description:"Ano passado decidi explorar como garantir escrever em um arquivo sem que outros processos atrapalhem. Isto levou a cria\xe7\xe3o do post: Lock Files Process.",date:"2025-10-04T00:00:00.000Z",formattedDate:"October 4, 2025",tags:[{label:"file",permalink:"/en/blog/tags/file"},{label:"files",permalink:"/en/blog/tags/files"},{label:"database",permalink:"/en/blog/tags/database"},{label:"multiple",permalink:"/en/blog/tags/multiple"},{label:"lock",permalink:"/en/blog/tags/lock"}],hasTruncateMarker:!1,authors:[{name:"Thiago Lages de Alencar",title:"Desenvolvedor de Software",url:"https://github.com/thiagola92",imageURL:"/img/dino.svg",key:"thiagola92"}],frontMatter:{authors:"thiagola92",tags:["file","files","database","multiple","lock"]},unlisted:!1,nextItem:{title:"Discord Social SDK",permalink:"/en/blog/2025/06/03/discord-social-sdk"}},c={authorsImageUrls:[void 0]},d=[{value:"Problem 1",id:"problem-1",level:2},{value:"Problem 2",id:"problem-2",level:2},{value:"Problem 3",id:"problem-3",level:2},{value:"Solution 1",id:"solution-1",level:2},{value:"Solution 1+",id:"solution-1-1",level:3},{value:"Solution 1++",id:"solution-1-2",level:3},{value:"Solution 2",id:"solution-2",level:2},{value:"Solution 2+",id:"solution-2-1",level:3},{value:"Solution 2++",id:"solution-2-2",level:3},{value:"Solution 3",id:"solution-3",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}];function t(e){const o={a:"a",admonition:"admonition",blockquote:"blockquote",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(o.p,{children:["Ano passado decidi explorar como garantir escrever em um arquivo sem que outros processos atrapalhem. Isto levou a cria\xe7\xe3o do post: ",(0,i.jsx)(o.a,{href:"/en/blog/2024/07/29/lock-file-process",children:"Lock Files Process"}),"."]}),"\n",(0,i.jsx)(o.p,{children:"Agora o problema que tenho refletido \xe9 sobre como editar arquivos de forma segura."}),"\n",(0,i.jsx)(o.h2,{id:"problem-1",children:"Problem 1"}),"\n",(0,i.jsx)(o.p,{children:"Se eu possuo apenas um arquivo, eu posso utilizar locks do sistema operacional para evitar que outros processos leiam/escrevam enquanto eu estou escrevendo."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 file_a.json (get lock)\nprocess_2\n\u2514\u2500\u2500 file_a.json (wait lock)\n"})}),"\n",(0,i.jsx)(o.admonition,{type:"note",children:(0,i.jsx)(o.p,{children:"Isso n\xe3o impede que processos m\xe1 intencionados corrompam seu arquivo, pois eles ainda podem ignorar estas locks."})}),"\n",(0,i.jsx)(o.p,{children:"Mas o que acontece se tivermos no meio de escrever um arquivo grande e o computador desligar/travar? Existe o risco do nosso arquivo ficar escrito pela metade..."}),"\n",(0,i.jsx)(o.h2,{id:"problem-2",children:"Problem 2"}),"\n",(0,i.jsx)(o.p,{children:"Vamos supor que temos a solu\xe7\xe3o do problema acima, como solucionamos para casos onde um comando da CLI precisa alterar diversos arquivo e o computador desliga/trava no meio?"}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u251c\u2500\u2500 file_a.json (editing)\n\u251c\u2500\u2500 file_b.json (editing)\n\u2514\u2500\u2500 file_c.json (editing)\n"})}),"\n",(0,i.jsx)(o.p,{children:"Isto quer dizer que pode travar ap\xf3s terminar de editar um arquivo enquanto os outros n\xe3o:"}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u251c\u2500\u2500 file_a.json (edited)\n\u251c\u2500\u2500 file_b.json (editing)\n\u2514\u2500\u2500 file_c.json (editing)\n"})}),"\n",(0,i.jsxs)(o.p,{children:["Ler do arquivo ",(0,i.jsx)(o.code,{children:"file_a.json"})," poderia nos dar a ilus\xe3o que o comando da CLI funcionou quando na realidade nem tudo foi aplicado."]}),"\n",(0,i.jsx)(o.h2,{id:"problem-3",children:"Problem 3"}),"\n",(0,i.jsx)(o.p,{children:"O outro problema que tenho refletido \xe9 quando m\xfaltiplos processos precisam alterar m\xfaltiplos arquivos ao mesmo tempo."}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"process_1"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_a.json"})," e ",(0,i.jsx)(o.code,{children:"file_b.json"}),(0,i.jsx)(o.br,{}),"\n",(0,i.jsx)(o.code,{children:"process_2"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_a.json"})," e ",(0,i.jsx)(o.code,{children:"file_b.json"})]}),"\n"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u251c\u2500\u2500 file_a.json (get lock)\n\u2514\u2500\u2500 file_b.json (get lock)\nprocess_2\n\u251c\u2500\u2500 file_a.json (wait lock)\n\u2514\u2500\u2500 file_b.json\n"})}),"\n",(0,i.jsxs)(o.p,{children:["Neste caso nenhum problema ocorre pois ",(0,i.jsx)(o.code,{children:"process_2"})," vai ficar esperando ",(0,i.jsx)(o.code,{children:"process_1"})," liberar a lock de ",(0,i.jsx)(o.code,{children:"file_a.json"})," para continuar com suas tarefas. Isso \xe9 o mesmo que executar os processos sequencialmente."]}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"process_1"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_a.json"})," e ",(0,i.jsx)(o.code,{children:"file_b.json"}),(0,i.jsx)(o.br,{}),"\n",(0,i.jsx)(o.code,{children:"process_2"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_b.json"})," e ",(0,i.jsx)(o.code,{children:"file_c.json"})]}),"\n"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 file_a.json (get lock)\nprocess_2\n\u2514\u2500\u2500 file_b.json (get lock)\nprocess_1\n\u2514\u2500\u2500 file_b.json (wait lock)\nprocess_2\n\u2514\u2500\u2500 file_c.json (get lock)\n"})}),"\n",(0,i.jsxs)(o.p,{children:["Neste caso, mesmo ",(0,i.jsx)(o.code,{children:"process_1"})," come\xe7ando primeiro, ele vai ter que esperar ",(0,i.jsx)(o.code,{children:"process_2"})," liberar a lock que foi pega no meio da execu\xe7\xe3o dele. Isso tamb\xe9m n\xe3o \xe9 um caso ruim, pois no final a lock deve ser liberada."]}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"process_1"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_a.json"})," e ",(0,i.jsx)(o.code,{children:"file_b.json"}),(0,i.jsx)(o.br,{}),"\n",(0,i.jsx)(o.code,{children:"process_2"})," precisa utilizar ",(0,i.jsx)(o.code,{children:"file_b.json"})," e ",(0,i.jsx)(o.code,{children:"file_a.json"})]}),"\n"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 file_a.json (get lock)\nprocess_2\n\u2514\u2500\u2500 file_b.json (get lock)\nprocess_1\n\u2514\u2500\u2500 file_b.json (wait lock)\nprocess_2\n\u2514\u2500\u2500 file_a.json (wait lock)\n"})}),"\n",(0,i.jsxs)(o.p,{children:["\xc9 neste caso em que um ",(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Deadlock_(computer_science)",children:"deadlock"})," ocorre. Onde ambos processos ficam esperando um pelo o outro e podem nunca sair do loop."]}),"\n",(0,i.jsx)(o.p,{children:"Mesmo que eu considere qualquer timeout que os processos tenham, nada impede de acontecer novamente e novamente... Ent\xe3o n\xe3o \xe9 ideal s\xf3 esperar que n\xe3o aconte\xe7a."}),"\n",(0,i.jsx)(o.h2,{id:"solution-1",children:"Solution 1"}),"\n",(0,i.jsx)(o.p,{children:"Uma maneira de solucionar isto \xe9 escrever em arquivos tempor\xe1rios e no final substituir os originais."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u251c\u2500\u2500 file_a.json\n\u2514\u2500\u2500 file_a.temp\n"})}),"\n",(0,i.jsxs)(o.p,{children:["Veja bem, enquanto voc\xea escreve nos arquivos tempor\xe1rios, os arquivos originais v\xe3o ficar intactos e sem risco de serem corrompidos em caso de falhas no sistema. Quando finalmente voc\xea terminar de escrever o que queria neles, voc\xea substitui os originais utilizando uma opera\xe7\xe3o at\xf3mica (",(0,i.jsx)(o.a,{href:"https://man7.org/linux/man-pages/man1/mv.1.html",children:(0,i.jsx)(o.code,{children:"mv"})})," ou ",(0,i.jsx)(o.a,{href:"https://man7.org/linux/man-pages/man1/rename.1.html",children:(0,i.jsx)(o.code,{children:"rename"})}),")."]}),"\n",(0,i.jsx)(o.p,{children:"Basicamente a l\xf3gica \xe9:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Dado que temos o arquivo original (",(0,i.jsx)(o.code,{children:"xxxx.json"}),")"]}),"\n",(0,i.jsxs)(o.li,{children:["Copie o conte\xfado do arquivo original para o tempor\xe1rio (",(0,i.jsx)(o.code,{children:"xxxx.temp"}),")"]}),"\n",(0,i.jsx)(o.li,{children:"Escreva sempre no arquivo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:"Substitua o arquivo original pelo tempor\xe1rio"}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Se considerarmos que temos locks:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Dado que temos o arquivo original (",(0,i.jsx)(o.code,{children:"xxxx.json"}),")"]}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:"Pegue a lock do arquivo original"})}),"\n",(0,i.jsxs)(o.li,{children:["Copie o conte\xfado do arquivo original para o tempor\xe1rio (",(0,i.jsx)(o.code,{children:"xxxx.temp"}),")"]}),"\n",(0,i.jsx)(o.li,{children:"Escreva sempre no arquivo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:"Substitua o arquivo original pelo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:"Solte a lock do arquivo original"})}),"\n"]}),"\n",(0,i.jsx)(o.admonition,{type:"warning",children:(0,i.jsxs)(o.p,{children:["Ambas opera\xe7\xf5es ",(0,i.jsx)(o.code,{children:"mv"})," e ",(0,i.jsx)(o.code,{children:"rename"})," s\xe3o at\xf3micas quando se trata do mesmo volume (HD/SSD) pois \xe9 s\xf3 um redirecionamento do ponteiro. Se estivermos falando dessas opera\xe7\xf5es entre volumes diferentes, seria preciso que um volume copiasse para o outro volume antes e isso ",(0,i.jsx)(o.strong,{children:"n\xe3o"})," \xe9 at\xf3mico."]})}),"\n",(0,i.jsxs)(o.p,{children:["Por\xe9m como estamos lidando com locks, e \xe9 necess\xe1rio saber se podemos renomear um arquivo com lock... A resposta \xe9 ",(0,i.jsx)(o.strong,{children:"sim para Linux/Macos"})," e ",(0,i.jsx)(o.strong,{children:"n\xe3o para Windows"}),"."]}),"\n",(0,i.jsx)(o.p,{children:"Isso ocorre pois Windows utiliza mandatory lock (em vez de advisory lock), isso obriga todos os processos a respeitarem o acesso aquele arquivo e proibi a remo\xe7\xe3o do arquivo enquanto possuir uma lock."}),"\n",(0,i.jsx)(o.h3,{id:"solution-1-1",children:"Solution 1+"}),"\n",(0,i.jsx)(o.p,{children:"Podemos contornar esse problema utilizando um arquivo de acesso como lock."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u251c\u2500\u2500 file_a.json\n\u251c\u2500\u2500 file_a.lock\n\u2514\u2500\u2500 file_a.temp\n"})}),"\n",(0,i.jsx)(o.p,{children:"Agora nos criamos a regra interna que apenas aqueles com a lock do arquivo de acesso podem escrever no arquivo."}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Dado que temos o arquivo original (",(0,i.jsx)(o.code,{children:"xxxx.json"}),")"]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Pegue a lock do arquivo de acesso"})," (",(0,i.jsx)(o.code,{children:"xxxx.lock"}),")"]}),"\n",(0,i.jsxs)(o.li,{children:["Copie o conte\xfado do arquivo original para o tempor\xe1rio (",(0,i.jsx)(o.code,{children:"xxxx.temp"}),")"]}),"\n",(0,i.jsx)(o.li,{children:"Escreva sempre no arquivo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:"Substitua o arquivo original pelo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:"Solte a lock do arquivo de acesso"})}),"\n"]}),"\n",(0,i.jsx)(o.h3,{id:"solution-1-2",children:"Solution 1++"}),"\n",(0,i.jsxs)(o.p,{children:["Existe um pequeno detalhe que eu esqueci de cobrir... Enquanto opera\xe7\xf5es as opera\xe7\xf5es ",(0,i.jsx)(o.code,{children:"rename"})," e ",(0,i.jsx)(o.code,{children:"mv"})," s\xe3o at\xf3micas na mem\xf3ria (RAM), isso ",(0,i.jsx)(o.strong,{children:"n\xe3o"})," quer dizer que sua mudan\xe7as j\xe1 foram para o storage (HD/SSD)."]}),"\n",(0,i.jsxs)(o.p,{children:["CPU trabalha com a mem\xf3ria e de tempos em tempos armazena as altera\xe7\xf5es no storage, ou seja, a gente chama ",(0,i.jsx)(o.code,{children:"rename"})," e todos os processos j\xe1 v\xe3o poder ver isso como verdade... Mas n\xe3o quer dizer que as mudan\xe7as j\xe1 foram salvas no storage."]}),"\n",(0,i.jsxs)(o.p,{children:["Por isto que precisamos utilizar comandos como ",(0,i.jsx)(o.code,{children:"fsync"})," que for\xe7\xe3o o flush dos dados no nosso storage."]}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Dado que temos o arquivo original (",(0,i.jsx)(o.code,{children:"xxxx.json"}),")"]}),"\n",(0,i.jsxs)(o.li,{children:["Pegue a lock do arquivo de acesso (",(0,i.jsx)(o.code,{children:"xxxx.lock"}),")"]}),"\n",(0,i.jsxs)(o.li,{children:["Copie o conte\xfado do arquivo original para o tempor\xe1rio (",(0,i.jsx)(o.code,{children:"xxxx.temp"}),")"]}),"\n",(0,i.jsx)(o.li,{children:"Escreva sempre no arquivo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsxs)(o.strong,{children:[(0,i.jsx)(o.code,{children:"fsync"})," no arquivo tempor\xe1rio"]})}),"\n",(0,i.jsx)(o.li,{children:"Substitua o arquivo original pelo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsxs)(o.strong,{children:[(0,i.jsx)(o.code,{children:"fsync"})," no diret\xf3rio do arquivo original"]})}),"\n",(0,i.jsx)(o.li,{children:"Solte a lock do arquivo de acesso"}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsxs)(o.em,{children:["O primeiro ",(0,i.jsx)(o.code,{children:"fsync"})," garante que o arquivo tempor\xe1rio esteja storage antes de substituir o original."]})}),"\n",(0,i.jsxs)(o.admonition,{type:"danger",children:[(0,i.jsxs)(o.p,{children:["Imagina se a gente usasse ",(0,i.jsx)(o.code,{children:"rename"}),", sem ele ter sido armazenado no storage!"]}),(0,i.jsxs)(o.p,{children:["Voc\xea apenas est\xe1 substituindo os ponteiros quando faz um ",(0,i.jsx)(o.code,{children:"rename"}),", ent\xe3o \xe9 bom voc\xea ter certeza que o ponteiro seja para um espa\xe7o do drive com conte\xfado (caso contr\xe1rio voc\xea est\xe1 apontando para lixo)."]})]}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsxs)(o.em,{children:["O segundo ",(0,i.jsx)(o.code,{children:"fsync"})," atualiza o metadata do diret\xf3rio (os arquivos que ele possue)."]})}),"\n",(0,i.jsx)(o.h2,{id:"solution-2",children:"Solution 2"}),"\n",(0,i.jsx)(o.p,{children:"Para garantir a atomicidade dessa altera\xe7\xe3o em conjunto, podemos criar um journal que ir\xe1 armazenar todos os arquivos que precisam ser substituidos e seus estados."}),"\n",(0,i.jsx)(o.p,{children:"Iremos definir 3 estados para nossos arquivos tempor\xe1rios:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["WRITE","\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Processo pode estar copiando o arquivo original"}),"\n",(0,i.jsx)(o.li,{children:"Processo pode estar alterando o arquivo tempor\xe1rio"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(o.li,{children:["REPLACE","\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Processo n\xe3o vai fazer mais altera\xe7\xf5es no arquivo tempor\xe1rio"}),"\n",(0,i.jsx)(o.li,{children:"Processo est\xe1 substituindo o arquivo original pelo tempor\xe1rio"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(o.li,{children:["DELETE","\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Processo j\xe1 substituiu o arquivo original"}),"\n",(0,i.jsx)(o.li,{children:"Processo est\xe1 deletando o arquivo tempor\xe1rio"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Os arquivos tempor\xe1rio caminham pelos estados na ordem WRITE, REPLACE, DELETE."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 journal\n    \u251c\u2500\u2500 file_a.temp (WRITE)\n    \u251c\u2500\u2500 file_b.temp (WRITE)\n    \u2514\u2500\u2500 file_c.temp (WRITE)\n"})}),"\n",(0,i.jsx)(o.p,{children:"Encontrar um arquivo no estado WRITE indica que o processo nunca terminou de escrever os tempor\xe1rios, ent\xe3o voc\xea pode descartar todos os arquivos tempor\xe1rios pois n\xe3o \xe9 poss\xedvel continuar de onde a tarefa parou."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 journal\n    \u251c\u2500\u2500 file_a.temp (REPLACE)\n    \u251c\u2500\u2500 file_b.temp (REPLACE)\n    \u2514\u2500\u2500 file_c.temp (REPLACE)\n"})}),"\n",(0,i.jsx)(o.p,{children:"Encontrar um arquivo no estado REPLACE indica que \xe9 poss\xedvel terminar a tarefa pois o arquivo tempor\xe1rio j\xe1 terminou de ser alterado, basta voc\xea terminar de substituir o arquivo."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 journal\n    \u251c\u2500\u2500 file_a.temp (DELETE)\n    \u251c\u2500\u2500 file_b.temp (DELETE)\n    \u2514\u2500\u2500 file_c.temp (DELETE)\n"})}),"\n",(0,i.jsx)(o.p,{children:"Encontrar um arquivo no estado DELETE indica que ele precisa ser removido pois j\xe1 foi utilizado como deveria."}),"\n",(0,i.jsx)(o.p,{children:"\xc9 importante notar que todos os arquivos devem caminhar em conjunto pelas etapas. Por exemplo:"}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 journal\n    \u251c\u2500\u2500 file_a.temp (REPLACE)\n    \u251c\u2500\u2500 file_b.temp (WRITE)\n    \u2514\u2500\u2500 file_c.temp (WRITE)\n"})}),"\n",(0,i.jsxs)(o.p,{children:["O arquivo ",(0,i.jsx)(o.code,{children:"file_a.temp"})," ",(0,i.jsx)(o.strong,{children:"n\xe3o"})," pode ir para o estado DELETE at\xe9 que todos os outros arquivos estejam no mesmo estado que ele (REPLACE)."]}),"\n",(0,i.jsxs)(o.p,{children:["A aus\xeancia dessa regra pode criar cen\xe1rios imposs\xedveis de se recuperar ",(0,i.jsx)(o.strong,{children:"ap\xf3s uma falha no sistema"}),". Por exemplo:"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:"process_1\n\u2514\u2500\u2500 journal\n    \u251c\u2500\u2500 file_a.temp (DELETE)\n    \u251c\u2500\u2500 file_b.temp (WRITE)\n    \u2514\u2500\u2500 file_c.temp (WRITE)\n"})}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["N\xe3o temos como reverter a altera\xe7\xe3o no ",(0,i.jsx)(o.code,{children:"file_a.temp"})," pois j\xe1 substituimos o arquivo"]}),"\n",(0,i.jsxs)(o.li,{children:["N\xe3o podemos completar de escrever o conte\xfado de ",(0,i.jsx)(o.code,{children:"file_b.temp"})," e ",(0,i.jsx)(o.code,{children:"file_c.temp"})," pois n\xe3o sabemos o que estava sendo escrito"]}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"O pr\xf3ximo problema que temos \xe9... Onde armazenar esse journal? Outro processos v\xe3o precisar ver ele para saber se precisam terminar alguma opera\xe7\xe3o passada."}),"\n",(0,i.jsx)(o.h3,{id:"solution-2-1",children:"Solution 2+"}),"\n",(0,i.jsxs)(o.p,{children:["Podemos armazenar o journal de cada processo em um arquivo dentro de um diret\xf3rio qualquer (iremos chamar o diret\xf3rio de ",(0,i.jsx)(o.code,{children:".journals"}),")."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:".journals\n\u251c\u2500\u2500 <pid_0001>.journal\n\u251c\u2500\u2500 <pid_0002>.journal\n\u2514\u2500\u2500 <pid_0003>.journal\n"})}),"\n",(0,i.jsxs)(o.p,{children:["Utilizamos o ",(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Process_identifier",children:"PID"})," de cada processo como nome dos arquivos (pois eles s\xe3o \xfanicos)."]}),"\n",(0,i.jsx)(o.p,{children:"Agora precisamos garantir o tratamento de qualquer journal incompleto, para isto vamos definir regras que todo processo deve executar antes de come\xe7ar sua pr\xf3pria tarefa:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Verifica se ",(0,i.jsx)(o.code,{children:"<pid>.journal"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Se existir, n\xf3s sabemos que foi um processo antigo que n\xe3o finalizou ent\xe3o come\xe7amos o tratamento"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(o.li,{children:["Verifica se outro jornal incompleto existe","\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Se existir, n\xf3s iniciamos o tratamento daquele journal"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Como sabemos que PIDs s\xe3o \xfanicos \xe9 f\xe1cil saber que um journal com o nosso PID \xe9 um journal incompleto. Mas como sabemos se outros journals s\xe3o incompletos ou possuem algu\xe9m processando?"}),"\n",(0,i.jsx)(o.h3,{id:"solution-2-2",children:"Solution 2++"}),"\n",(0,i.jsx)(o.p,{children:"Podemos utilizar locks para informar a outro processos que este journal est\xe1 em tratamento."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{children:".journals\n\u251c\u2500\u2500 <pid_0001>.journal (write lock)\n\u251c\u2500\u2500 <pid_0002>.journal (write lock)\n\u2514\u2500\u2500 <pid_0003>.journal (no lock)\n"})}),"\n",(0,i.jsx)(o.p,{children:"Se o processo encontrar um journal sem lock, n\xf3s teremos certeza que ningu\xe9m est\xe1 tratando ele no momento e devemos pegar o lock para n\xf3s e terminar o journal."}),"\n",(0,i.jsx)(o.h2,{id:"solution-3",children:"Solution 3"}),"\n",(0,i.jsx)(o.p,{children:"Para garantir que n\xe3o exista deadlock, precisamos garantir que um processo pegue suas locks antes de outro processo tentar pegar as deles."}),"\n",(0,i.jsxs)(o.p,{children:["Para isto criaremos um arquivo que chamaremos de ",(0,i.jsx)(o.code,{children:".global.lock"}),", o qual todos os processos devem tentar pegar a lock antes de iniciar as tarefas."]}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:["Se nosso processo n\xe3o conseguir a lock do ",(0,i.jsx)(o.code,{children:".global.lock"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Existe um processo pegando locks, devemos aguardar"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(o.li,{children:["Caso contr\xe1rio","\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"N\xf3s podemos pegar as locks que s\xe3o necess\xe1rias para nossa tarefa"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(o.p,{children:["\xc9 importante que essa lock seja liberada ap\xf3s aquele processo pegar as locks que precisa (ou falhar em pegar), caso contr\xe1rio diversos processos podem acabar esperando pela libera\xe7\xe3o da ",(0,i.jsx)(o.code,{children:".global.lock"}),"."]}),"\n",(0,i.jsx)(o.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(o.p,{children:"Eu n\xe3o comecei a escrever nada de c\xf3digo ainda mas posso garantir uma coisa... Vai ser lento."}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Clonar o arquivo original"}),"\n",(0,i.jsx)(o.li,{children:"Read & Write no journal o tempo todo"}),"\n",(0,i.jsx)(o.li,{children:"Lock & Unlock arquivos o tempo todo"}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Tudo \xe9 receita para ser bem lento, n\xe3o \xe9 atoa que SQLite faz tudo em um arquivo e trabalha maior parte na mem\xf3ria RAM."}),"\n",(0,i.jsx)(o.p,{children:"Dito isto, isto vai ser um projeto interessante para mim."}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Rosto feliz",src:s(65184).Z+"",width:"300",height:"300"})}),"\n",(0,i.jsx)(o.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Deadlock_(computer_science)",children:"https://en.wikipedia.org/wiki/Deadlock_(computer_science)"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://man7.org/linux/man-pages/man1/mv.1.html",children:"https://man7.org/linux/man-pages/man1/mv.1.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://man7.org/linux/man-pages/man1/rename.1.html",children:"https://man7.org/linux/man-pages/man1/rename.1.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://man7.org/linux/man-pages/man2/fsync.2.html",children:"https://man7.org/linux/man-pages/man2/fsync.2.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/File_locking",children:"https://en.wikipedia.org/wiki/File_locking"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Atomicity_(database_systems)",children:"https://en.wikipedia.org/wiki/Atomicity_(database_systems)"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Write-ahead_logging",children:"https://en.wikipedia.org/wiki/Write-ahead_logging"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Transaction_log",children:"https://en.wikipedia.org/wiki/Transaction_log"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Rollback_(data_management)",children:"https://en.wikipedia.org/wiki/Rollback_(data_management)"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://www.sqlite.org/tempfiles.html",children:"https://www.sqlite.org/tempfiles.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://www.sqlite.org/lockingv3.html",children:"https://www.sqlite.org/lockingv3.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://www.sqlite.org/wal.html",children:"https://www.sqlite.org/wal.html"})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.a,{href:"https://www.slideshare.net/slideshow/eat-my-data/9002060",children:"https://www.slideshare.net/slideshow/eat-my-data/9002060"})}),"\n"]})]})}function u(e={}){const{wrapper:o}={...(0,n.a)(),...e.components};return o?(0,i.jsx)(o,{...e,children:(0,i.jsx)(t,{...e})}):t(e)}},65184:(e,o,s)=>{s.d(o,{Z:()=>i});const i="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB3aWR0aD0iMzAwIgogICBoZWlnaHQ9IjMwMCIKICAgdmlld0JveD0iMCAwIDMwMCAzMDAiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2ZzEiCiAgIGlua3NjYXBlOnZlcnNpb249IjEuMi4yIChiMGE4NDg2NTQxLCAyMDIyLTEyLTAxKSIKICAgc29kaXBvZGk6ZG9jbmFtZT0iaGFwcHkuc3ZnIgogICBpbmtzY2FwZTpleHBvcnQtZmlsZW5hbWU9ImJsdWUucG5nIgogICBpbmtzY2FwZTpleHBvcnQteGRwaT0iOTYiCiAgIGlua3NjYXBlOmV4cG9ydC15ZHBpPSI5NiIKICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiCiAgIHhtbG5zOnNvZGlwb2RpPSJodHRwOi8vc29kaXBvZGkuc291cmNlZm9yZ2UubmV0L0RURC9zb2RpcG9kaS0wLmR0ZCIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgaWQ9Im5hbWVkdmlldzEiCiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjMDAwMDAwIgogICAgIGJvcmRlcm9wYWNpdHk9IjAuMjUiCiAgICAgaW5rc2NhcGU6c2hvd3BhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAuMCIKICAgICBpbmtzY2FwZTpwYWdlY2hlY2tlcmJvYXJkPSIwIgogICAgIGlua3NjYXBlOmRlc2tjb2xvcj0iI2QxZDFkMSIKICAgICBpbmtzY2FwZTpkb2N1bWVudC11bml0cz0icHgiCiAgICAgc2hvd2dyaWQ9InRydWUiCiAgICAgaW5rc2NhcGU6em9vbT0iMi4xIgogICAgIGlua3NjYXBlOmN4PSIxNTMuMzMzMzMiCiAgICAgaW5rc2NhcGU6Y3k9IjE1NC4wNDc2MiIKICAgICBpbmtzY2FwZTp3aW5kb3ctd2lkdGg9IjE5MjAiCiAgICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iMTA0MSIKICAgICBpbmtzY2FwZTp3aW5kb3cteD0iMCIKICAgICBpbmtzY2FwZTp3aW5kb3cteT0iMCIKICAgICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIxIgogICAgIGlua3NjYXBlOmN1cnJlbnQtbGF5ZXI9ImxheWVyMSI+CiAgICA8aW5rc2NhcGU6Z3JpZAogICAgICAgaWQ9ImdyaWQxIgogICAgICAgdW5pdHM9InB4IgogICAgICAgb3JpZ2lueD0iMCIKICAgICAgIG9yaWdpbnk9IjAiCiAgICAgICBzcGFjaW5neD0iMSIKICAgICAgIHNwYWNpbmd5PSIxIgogICAgICAgZW1wY29sb3I9IiMwMDQ4ZTUiCiAgICAgICBlbXBvcGFjaXR5PSIwLjMwMTk2MDc4IgogICAgICAgY29sb3I9IiMwMDk5ZTUiCiAgICAgICBvcGFjaXR5PSIwLjE0OTAxOTYxIgogICAgICAgZW1wc3BhY2luZz0iMTAiCiAgICAgICBkb3R0ZWQ9ImZhbHNlIgogICAgICAgZ3JpZGFuZ2xleD0iMzAiCiAgICAgICBncmlkYW5nbGV6PSIzMCIKICAgICAgIHZpc2libGU9InRydWUiCiAgICAgICBzbmFwdmlzaWJsZWdyaWRsaW5lc29ubHk9ImZhbHNlIgogICAgICAgZW5hYmxlZD0idHJ1ZSIgLz4KICA8L3NvZGlwb2RpOm5hbWVkdmlldz4KICA8ZGVmcwogICAgIGlkPSJkZWZzMSIgLz4KICA8ZwogICAgIGlua3NjYXBlOmxhYmVsPSJMYXllciAxIgogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMSI+CiAgICA8cGF0aAogICAgICAgaWQ9InBhdGgxIgogICAgICAgc3R5bGU9ImZpbGw6IzMzYzI1NTtmaWxsLW9wYWNpdHk6MTtzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MzIuNDAwNztzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW9wYWNpdHk6MSIKICAgICAgIGQ9Ik0gMTE0LjkwODEsMTkuMDM1MjUgQSAxMzUuNTg0MTYsMTM1LjU4NDE3IDc1IDAgMCAxOS4wMzcxNTMsMTg1LjA5MyAxMzUuNTg0MTYsMTM1LjU4NDE3IDc1IDAgMCAxODUuMDkxOSwyODAuOTY0NzYgMTM1LjU4NDE2LDEzNS41ODQxNyA3NSAwIDAgMjgwLjk2MzY1LDExNC45MSAxMzUuNTg0MTYsMTM1LjU4NDE3IDc1IDAgMCAxMTQuOTA4MSwxOS4wMzUyNSBaIE0gNzQuNjg1OTg5LDYxLjg2NjEyOCBBIDU3LjI4MjI3LDMwLjEzMTI3MiA3NSAwIDEgMTE4LjYxMzk5LDEwOS4zOTcyIDU3LjI4MjI3LDMwLjEzMTI3MiA3NSAwIDEgMTA0LjMzNzU4LDE3Mi41MjczNSA1Ny4yODIyNywzMC4xMzEyNzIgNzUgMCAxIDYwLjQwNTc0MSwxMjQuOTk0MDYgNTcuMjgyMjcsMzAuMTMxMjcyIDc1IDAgMSA3NC42ODU5ODksNjEuODY2MTI4IFogTSAxNzEuMTU2OTEsMzYuMDE2ODI2IGEgNTcuMjgyMjcsMzAuMTMxMjcyIDc1IDAgMSA0My45MzEwMiw0Ny41MzAyNTkgNTcuMjgyMjcsMzAuMTMxMjcyIDc1IDAgMSAtMTQuMjc5NDQsNjMuMTMwOTY1IDU3LjI4MjI3LDMwLjEzMTI3MiA3NSAwIDEgLTQzLjkyODgsLTQ3LjUzNDEwOCA1Ny4yODIyNywzMC4xMzEyNzIgNzUgMCAxIDE0LjI3NzIyLC02My4xMjcxMTYgeiBNIDkyLjE1Nzk1OSwxODEuNTI1NDMgYSAyNC4wMjA4MTYsMjQuMDIwODE2IDAgMCAxIDEwLjY4MTg3MSwtMC4zODgzNCBjIDM5LjMyMjIxLDcuNDc5MzUgNzEuMTYxNTgsMS41MzE0MSAxMDMuMTQ4OTYsLTI3LjM3OTYzIGEgMjQuMDIwODE2LDI0LjAyMDgxNiAwIDAgMSAxMS4wNjgwMywtNS42NjYyIDI0LjAyMDgxNiwyNC4wMjA4MTYgMCAwIDEgMjIuODU4OTYsNy4zNzc2MSAyNC4wMjA4MTYsMjQuMDIwODE2IDAgMCAxIC0xLjcxMTM5LDMzLjkyNjk4IGMgLTQyLjQzNjksMzguMzU1NiAtOTQuMTczNzYsNDguNDc3OTUgLTE0NC4zNDI1MzgsMzguOTM1NTEgYSAyNC4wMjA4MTYsMjQuMDIwODE2IDAgMCAxIC0xOS4xMDgxNCwtMjguMDg2MTIgMjQuMDIwODE2LDI0LjAyMDgxNiAwIDAgMSAxNy40MDQyNDcsLTE4LjcxOTgxIHoiIC8+CiAgPC9nPgo8L3N2Zz4K"},11151:(e,o,s)=>{s.d(o,{Z:()=>l,a:()=>a});var i=s(67294);const n={},r=i.createContext(n);function a(e){const o=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function l(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),i.createElement(r.Provider,{value:o},e.children)}}}]);